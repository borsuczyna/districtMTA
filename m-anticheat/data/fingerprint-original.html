<script>
    let Fingerprint = function (options) {
        let nativeForEach, nativeMap;
        nativeForEach = Array.prototype.forEach;
        nativeMap = Array.prototype.map;

        this.each = function (obj, iterator, context) {
            if (obj === null) {
                return;
            }
            if (nativeForEach && obj.forEach === nativeForEach) {
                obj.forEach(iterator, context);
            } else if (obj.length === +obj.length) {
                for (let i = 0, l = obj.length; i < l; i++) {
                    if (iterator.call(context, obj[i], i, obj) === {}) return;
                }
            } else {
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (iterator.call(context, obj[key], key, obj) === {}) return;
                    }
                }
            }
        };

        this.map = function (obj, iterator, context) {
            let results = [];
            if (obj == null) return results;
            if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);
            this.each(obj, function (value, index, list) {
                results[results.length] = iterator.call(context, value, index, list);
            });
            return results;
        };

        if (typeof options == 'object') {
            //Overloading for passing draw or now some data on canvas - good for demonstration purposes
            this.hasher = options.hasher;
            this.canvas = options.canvas;
        } else if (typeof options == 'function') {
            //Overloading for custom hash functions
            this.hasher = options;
        }
    };

    Fingerprint.prototype = {
        get: function () {
            let keys = [];
            keys.push(navigator.userAgent);
            keys.push(navigator.language);
            keys.push(screen.colorDepth);
            if (document.body) {
                keys.push(typeof (document.body.addBehavior));
            } else {
                keys.push(typeof undefined);
            }
            keys.push(typeof (window.openDatabase));
            keys.push(navigator.cpuClass);
            keys.push(navigator.platform);
            keys.push(navigator.doNotTrack);
            keys.push(this.getPluginsString());
            if (this.canvas && this.isCanvasSupported()) {
                keys.push(this.getCanvasFingerprint());
            }
            if (this.hasher) {
                return this.hasher(keys.join('###'), 31);
            } else {
                return murmurhash3_32_gc(keys.join('###'), 31);
            }
        },

        hasLocalStorage: function () {
            try {
                return !!window.localStorage;
            } catch (e) {
                return true;
            }
        },

        /**
         * If catch SecurityError, it means it exists
         * @returns {boolean} has session storage
         */
        hasSessionStorage: function () {
            try {
                return !!window.sessionStorage;
            } catch (e) {
                return true;
            }
        },

        /**
         * If catch SecurityError, it means it exists
         * @returns {boolean} has IndexDb
         */
        hasIndexDb: function () {
            try {
                return !!window.indexedDB;
            } catch (e) {
                return true;
            }
        },

        isCanvasSupported: function () {
            let elem = document.createElement('canvas');
            return !!(elem.getContext && elem.getContext('2d'));
        },

        isIE: function () {
            if (navigator.appName === 'Microsoft Internet Explorer') {
                return true;
            } else if (navigator.appName === 'Netscape' && /Trident/.test(navigator.userAgent)) {
                return true;
            }
            return false;
        },

        getPluginsString: function () {
            if (this.isIE()) {
                return this.getIEPluginsString();
            } else {
                return this.getRegularPluginsString();
            }
        },

        getRegularPluginsString: function () {
            return this.map(navigator.plugins, function (p) {
                let mimeTypes = this.map(p, function (mt) {
                    return [mt.type, mt.suffixes].join('~');
                }).join(',');
                return [p.name, p.description, mimeTypes].join('::');
            }, this).join(';');
        },

        /**
         * Fetch plugins specific to IE
         */
        getIEPluginsString: function () {
            if (window.ActiveXObject) {
                let names = ['ShockwaveFlash.ShockwaveFlash',
                    'AcroPDF.PDF',
                    'PDF.PdfCtrl',
                    'QuickTime.QuickTime',
                    'rmocx.RealPlayer G2 Control',
                    'rmocx.RealPlayer G2 Control.1',
                    'RealPlayer.RealPlayer(tm) ActiveX Control (32-bit)',
                    'RealVideo.RealVideo(tm) ActiveX Control (32-bit)',
                    'RealPlayer',
                    'SWCtl.SWCtl',
                    'WMPlayer.OCX',
                    'AgControl.AgControl', // Silverlight
                    'Skype.Detection'];

                return this.map(names, function (name) {
                    try {
                        new ActiveXObject(name);
                        return name;
                    } catch (e) {
                        return null;
                    }
                }).join(';');
            } else {
                return "";
            }
        },

        getScreenResolution: function () {
            return (screen.height > screen.width) ? [screen.height, screen.width] : [screen.width, screen.height];
        },

        getCanvasFingerprint: function () {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');
            let txt = 'CANVAS_FINGERPRINT';
            ctx.textBaseline = "top";
            ctx.font = "14px 'Arial'";
            ctx.textBaseline = "alphabetic";
            ctx.fillStyle = "#f60";
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = "#069";
            ctx.fillText(txt, 2, 15);
            ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
            ctx.fillText(txt, 4, 17);
            return canvas.toDataURL();
        }
    };

    function customHasher(data, seed) {
        let hash = 0, i, chr;
        if (data.length === 0) return hash;
        for (i = 0; i < data.length; i++) {
            chr = data.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }

        let charsTable = {
            [2]: ['v', 'e', 'k'],
            [5]: ['z', 'n', 'm'],
            [8]: ['m', 'b'],
            [10]: ['o'],
            [12]: ['g', 'c', 'f', 'e', 'v'],
            [15]: ['d', 'f', 'g', 'h', 'j', 'k', 'l', 'm', 'n', 'p', 'q', 'r', 's', 't', 'v', 'w', 'x', 'y'],
        };

        let closestChar = (number, chars) => {
            let closest = chars[0];
            let closestDiff = Math.abs(number - closest.charCodeAt(0));
            for (let i = 1; i < chars.length; i++) {
                let diff = Math.abs(number - chars[i].charCodeAt(0));
                if (diff < closestDiff) {
                    closest = chars[i];
                    closestDiff = diff;
                }
            }
            return closest;
        };

        hash = Math.abs(hash);
        hash = hash.toString().padStart(10, '0');
        hash = hash.slice(0, 5) + hash + hash.slice(5);

        for (let [index, chars] of Object.entries(charsTable)) {
            index = parseInt(index);
            if (hash.length >= index) {
                let number = parseInt(hash[index]);
                let closest = closestChar(number, chars);
                hash = hash.slice(0, index) + closest + hash.slice(index + 1);
            }
        }

        return hash;
    };

    let myHash = (new Fingerprint({ canvas: false, hasher: customHasher })).get();
    mta.triggerEvent('fingerprint:response', myHash);
</script>